# PromQL
PromQL分为三个核心部分：选择、加工和聚合。
## 核心数据类型与选择器 (Selection)
PromQL 查询返回的数据类型是 向量 (Vector)。
1. 指标与标签选择器  
这是所有查询的起点，用于从数据库中筛选出时间序列。

| 元素 |作用| 示例                                                                |
|-----------------------------|-------------------|-------------------------------------------------------------------|
|指标名称	|筛选特定名称的指标。	| node_cpu_seconds_total                                            | 
|标签选择器	|筛选符合标签条件的序列。	| node_cpu_seconds_total{mode="idle",instance="node-exporter:9100"} | 
|正则匹配	|模糊筛选标签值。	| node_cpu_seconds_total{mode=~"i.*"} (匹配所有以 i 开头的mode对象)           | 

2. 向量类型

| 类型 |格式| 含义|用途|
|-----------------------------|------------------|-----------------------------|------------|
|瞬时向量 (Instant Vector)	|无时间后缀	| 在`当前时间点`上，每条时间序列的最新值。|up，node_memory_MemFree_bytes |
|区间向量 (Range Vector)	|带有 [时间] 后缀	| 在`指定时间范围`内，每条时间序列的所有数据点。 | node_cpu_seconds_total[5m]|

## 数据加工与时间函数 (Manipulation)
这些函数用于处理`区间向量`，将原始数据转化为有意义的指标（如 QPS 或使用率）。  
1. Counter 类型处理（计算增长率）  
针对`只增不减`的Counter指标。

| 函数 |作用| 场景/差异| 示例                                |
|-----------------------------|------------------|-----------------------------|-----------------------------------|
|rate(v)	|计算时间序列在区间内的平均每秒增长率。	| 最常用。 提供平滑的平均值，用于 QPS、CPU 平均使用率等。| rate(node_cpu_seconds_total[5m])  |
|irate(v)	|计算时间序列的瞬时每秒增长率（基于最后两个数据点）。	| 敏感。 对突发变化响应快，常用于快速告警。 | irate(node_cpu_seconds_total[5m]) |
|increase(v)	|计算时间序列在区间内的总增长量。	| 容量规划、总请求数统计。 | increase(node_cpu_seconds_total[5m]) |

2. 时间聚合函数（跨时间聚合）  
针对`单个`时间序列在`指定时间窗口`内的操作。  

| 函数 |作用| 场景/差异| 示例                                        |
|-----------------------------|------------------|-----------------------------|-------------------------------------------|
|sum_over_time(v)	|求和。 对单个序列在区间内所有采样点的值求和。| 针对 Gauge，计算一段时间内的累计贡献值。| sum_over_time(node_cpu_seconds_total[5m]) |
|avg_over_time(v)	|求平均。 对单个序列在区间内所有采样点的值求平均。	| 计算一段时间内的平均内存、平均延迟等（Gauge）。 | avg_over_time(node_cpu_seconds_total[5m]) |
|max_over_time(v)	|求最大值。 对单个序列在区间内所有采样点的值取最大值。	| 查看过去 1 小时内的峰值负载。 | max_over_time(node_cpu_seconds_total[5m]) |

## 聚合、运算与关联 (Aggregation & Correlation)
1. 向量聚合运算符（跨向量聚合）  
用于将`多个时间序列`在`同一时间点`上进行聚合。

| 函数 |作用| 场景/差异| 示例                                        |
|-----------------------------|------------------|-----------------------------|-------------------------------------------|
|sum()	|对所有匹配的序列求和。| by (label)：按标签分组聚合。 without (label)：排除标签后聚合。| sum(sum_over_time(node_cpu_seconds_total[5m])) by (mode) |
|avg(), max(), count(), quantile()	|同理，进行求平均、最大值、计数或分位数计算。|  | sum(sum_over_time(node_cpu_seconds_total[5m])) by (mode) |

2. 二元运算符（向量运算）   
用于对两个瞬时向量进行加减乘除等运算。

| 运算符 |作用|  示例                                        |
|-----------------------------|------------------|-----------------------------|
|+, -, *, /	|逐个元素进行运算（需要标签匹配）。| 内存空闲 / 内存总量| 
|on()	|关联关键。 强制两个向量只根据指定的标签进行匹配。| a / on(instance) b  |
|group_left()	|用于一对多匹配时，将右侧向量的标签带入结果。| 复杂的指标关联，如计算成功率。 |

复杂组合示例


| 目标 |组合 PromQL| 解释流程                                                                                    |
|-----------------------------|------------------|-----------------------------------------------------------------------------------------|
|计算总内存使用率|(node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100| 选择内存指标 -> 运算（相减/相除） -> 结果（瞬时百分比）。                                                       | 
|计算 P99 延迟|histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))| 选择指标（Histogram）-> 加工（rate 计算增长率）-> 聚合（sum by (le)）-> 结果（histogram_quantile 计算最终 P99 值）。 |
|计算所有主机在 5 分钟内的平均负载	|avg(avg_over_time(node_load5[5m]))| 选择指标 -> 加工（avg_over_time 计算每个主机的 5 分钟平均负载）-> 聚合（avg 对所有主机求平均）。                          |

